# ============================================
# Logstash Pipeline Configuration
# ============================================
# Processes logs from multiple sources and sends to Elasticsearch

input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json_lines
    tags => ["tcp-input"]
  }

  # Beats input (Filebeat, Metricbeat, etc.)
  beats {
    port => 5044
    tags => ["beats-input"]
  }

  # Kafka input for streaming logs
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["application-logs", "pipeline-metrics", "pipeline-events"]
    codec => json
    group_id => "logstash-consumer"
    auto_offset_reset => "latest"
    tags => ["kafka-input"]
  }
}

filter {
  # Parse JSON if not already parsed
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # Extract timestamp
  if [parsed][timestamp] {
    date {
      match => ["[parsed][timestamp]", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Add environment metadata
  mutate {
    add_field => {
      "environment" => "development"
      "platform" => "dataflow-platform"
    }
  }

  # Tag pipeline events
  if [parsed][pipelineId] {
    mutate {
      add_tag => ["pipeline-event"]
      add_field => {
        "pipeline_id" => "%{[parsed][pipelineId]}"
      }
    }
  }

  # Extract metrics
  if [parsed][metrics] {
    mutate {
      add_tag => ["metrics"]
      add_field => {
        "total_batches" => "%{[parsed][metrics][totalBatches]}"
        "total_records" => "%{[parsed][metrics][totalRecordsProcessed]}"
        "total_failures" => "%{[parsed][metrics][totalFailures]}"
      }
    }
  }

  # Grok for log level extraction
  grok {
    match => {
      "message" => "%{LOGLEVEL:log_level}"
    }
    tag_on_failure => []
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["message", "host"]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "dataflow-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }
}
