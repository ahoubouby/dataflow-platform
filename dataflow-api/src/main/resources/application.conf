# ============================================
# DataFlow Platform API - Configuration
# ============================================

# Include core configuration
include "pekko-persistence-cassandra"

dataflow {
  api {
    # HTTP server configuration
    host = "0.0.0.0"
    host = ${?API_HOST}

    port = 8080
    port = ${?API_PORT}

    # Request timeout
    request-timeout = 30s

    # WebSocket configuration
    websocket {
      update-interval = 2s
    }
  }
}

# Apache Pekko configuration
pekko {
  loglevel = "INFO"

  actor {
    provider = cluster

    serialization-bindings {
      "com.dataflow.serialization.CborSerializable" = jackson-cbor
    }
  }

  # Remote configuration
  remote.artery {
    canonical {
      hostname = "127.0.0.1"
      hostname = ${?PEKKO_HOST}
      port = 2551
      port = ${?PEKKO_PORT}
    }
  }

  # Cluster configuration
  cluster {
    seed-nodes = ["pekko://DataFlowSystem@127.0.0.1:2551"]
    seed-nodes = ${?PEKKO_SEED_NODES}

    sharding {
      number-of-shards = 100

      # Passivation strategy
      passivation {
        # Default idle timeout for entities
        default-idle-strategy.idle-timeout = 5m
      }
    }

    # Downing provider
    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"
  }

  # Persistence configuration
  persistence {
    journal {
      plugin = "pekko.persistence.cassandra.journal"

      # Auto-create tables
      auto-start-journals = ["pekko.persistence.cassandra.journal"]
    }

    snapshot-store {
      plugin = "pekko.persistence.cassandra.snapshot"
    }

    cassandra {
      journal {
        keyspace = "dataflow_journal"
        table = "messages"

        # Enable auto-creation of tables (keyspace must exist)
        keyspace-autocreate = false
        tables-autocreate = true
      }

      snapshot {
        keyspace = "dataflow_snapshot"
        table = "snapshots"

        # Enable auto-creation of tables (keyspace must exist)
        keyspace-autocreate = false
        tables-autocreate = true
      }

      # Connection details
      datastax-java-driver-config = "datastax-java-driver"
    }
  }

  # HTTP configuration
  http {
    server {
      request-timeout = ${dataflow.api.request-timeout}
      idle-timeout = 60s

      # WebSocket settings
      websocket {
        periodic-keep-alive-max-idle = 10s
      }
    }
  }
}

# Datastax Java Driver configuration
datastax-java-driver {
  basic {
    contact-points = ["127.0.0.1:9042"]
    contact-points = ${?CASSANDRA_CONTACT_POINTS}

    load-balancing-policy.local-datacenter = "datacenter1"

    session-keyspace = "dataflow_journal"
  }

  advanced {
    reconnection-policy {
      class = ExponentialReconnectionPolicy
      base-delay = 1 second
      max-delay = 60 seconds
    }
  }
}

# Pekko Management configuration
pekko.management {
  http {
    hostname = "127.0.0.1"
    hostname = ${?MANAGEMENT_HOST}
    port = 8558
    port = ${?MANAGEMENT_PORT}
  }

  cluster.bootstrap {
    contact-point-discovery {
      service-name = "dataflow-api"
      discovery-method = config

      # For config-based discovery in local development
      required-contact-point-nr = 1
    }
  }
}
