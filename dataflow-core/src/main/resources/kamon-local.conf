# ============================================
# METRICS AND MONITORING (Kamon)
# ============================================
kamon {
  # Enable/disable Kamon
  enabled = true
  enabled = ${?KAMON_ENABLED}

  # Environment information
  environment {
    service = "dataflow-platform"
    service = ${?KAMON_SERVICE_NAME}

    host = "auto"
    host = ${?KAMON_HOST}

    instance = "auto"
    instance = ${?KAMON_INSTANCE}
  }

  # Metric collection settings
  metric {
    # How often to collect metrics
    tick-interval = 10 seconds

    # Optimistic tick alignment
    optimistic-tick-alignment = yes

    # Filters for metrics
    filters {
      # Accept all metrics by default
      dataflow {
        includes = ["dataflow.**"]
        excludes = []
      }

      # Akka/Pekko actor metrics
      akka-actor {
        includes = ["akka.actor.**", "pekko.actor.**"]
        excludes = []
      }

      # System metrics
      system {
        includes = ["system.**", "process.**", "jvm.**"]
        excludes = []
      }
    }
  }

  # Prometheus reporter configuration
  prometheus {
    # Start the embedded HTTP server for Prometheus scraping
    start-embedded-http-server = yes
    start-embedded-http-server = ${?KAMON_PROMETHEUS_EMBEDDED}

    # Port for Prometheus metrics endpoint
    embedded-server {
      hostname = "0.0.0.0"
      hostname = ${?KAMON_PROMETHEUS_HOST}

      port = 9096
      port = ${?KAMON_PROMETHEUS_PORT}
    }

    # Default buckets for histograms (processing time, etc.)
    buckets {
      default-buckets = [
        1,
        5,
        10,
        25,
        50,
        75,
        100,
        250,
        500,
        750,
        1000,
        2500,
        5000,
        7500,
        10000
      ]

      time-buckets = [
        0.001,
        0.005,
        0.01,
        0.025,
        0.05,
        0.075,
        0.1,
        0.25,
        0.5,
        0.75,
        1.0,
        2.5,
        5.0,
        7.5,
        10.0
      ]
    }
  }

  # System metrics (CPU, memory, GC)
  system-metrics {
    # Enable JVM metrics
    jvm {
      enabled = yes

      # Collect heap metrics
      heap {
        enabled = yes
      }

      # Collect non-heap metrics
      non-heap {
        enabled = yes
      }

      # Collect garbage collection metrics
      garbage-collection {
        enabled = yes
      }

      # Collect thread metrics
      threads {
        enabled = yes
      }
    }

    # Enable process metrics (CPU, file descriptors)
    process {
      enabled = yes
    }

    # Enable host metrics (CPU, memory, network, disk)
    host {
      enabled = no  # Requires sigar native library
      enabled = ${?KAMON_HOST_METRICS_ENABLED}
    }
  }

  # Instrumentation modules
  instrumentation {
    # Akka/Pekko actor instrumentation
    akka {
      # Track actor mailbox sizes
      actor {
        tracking {
          mailbox-size = yes
          time-in-mailbox = yes
          processing-time = yes
        }
      }

      # Track router metrics
      router {
        tracking {
          messages = yes
          time-in-mailbox = yes
          processing-time = yes
        }
      }
    }

    # Future/Promise instrumentation
    scala {
      futures {
        enabled = yes
      }
    }
  }

  # Module configuration
  modules {
    # Kamon Status Page (debug endpoint)
    status-page {
      name = "Status Page"
      description = "Kamon Status Page for debugging"  # ← ADD THIS LINE
      factory = "kamon.status.page.StatusPage$Factory"  # ← ADD THIS
      enabled = false
      enabled = ${?KAMON_STATUS_PAGE_ENABLED}

      listen {
        hostname = "0.0.0.0"
        port = 5266
      }
    }
  }

  # Trace configuration (optional - for distributed tracing)
  trace {
    # Sampling rate (0.0 to 1.0)
    sampler = "always"  # Use "random" or "adaptive" in production

    # Join remote traces
    join-remote-parents-with-same-span-id = yes

    # Trace ID length (8 or 16 bytes)
    identifier-scheme = "double"
  }
}
