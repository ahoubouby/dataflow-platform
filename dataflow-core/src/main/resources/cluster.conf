# ============================================
# CLUSTER CONFIGURATION
# ============================================

pekko {
  # ============================================
  # PEKKO MANAGEMENT
  # ============================================
  management {
    # HTTP management endpoint
    http {
      # Hostname for the management HTTP server
      hostname = "127.0.0.1"
      hostname = ${?PEKKO_MANAGEMENT_HTTP_HOSTNAME}

      # Port for the management HTTP server
      port = 8558
      port = ${?PEKKO_MANAGEMENT_HTTP_PORT}

      # Bind hostname (0.0.0.0 for all interfaces)
      bind-hostname = "0.0.0.0"
      bind-hostname = ${?PEKKO_MANAGEMENT_HTTP_BIND_HOSTNAME}

      # Bind port
      bind-port = 8558
      bind-port = ${?PEKKO_MANAGEMENT_HTTP_BIND_PORT}
    }

    # Cluster Bootstrap configuration
    cluster.bootstrap {
      # Contact point discovery method
      # Options: config, kubernetes-api, aws-api-ec2-tag-based, marathon-api, etc.
      contact-point-discovery {
        # Use config-based discovery for local development
        discovery-method = config
        discovery-method = ${?PEKKO_DISCOVERY_METHOD}

        # Service name for discovery
        service-name = "dataflow-platform"
        service-name = ${?PEKKO_DISCOVERY_SERVICE_NAME}

        # Port name for discovery (used in k8s)
        port-name = "management"

        # Required number of contact points
        required-contact-point-nr = 1
        required-contact-point-nr = ${?PEKKO_BOOTSTRAP_REQUIRED_CONTACT_POINTS}

        # Timeout for contact point probing
        contact-point-discovery-interval = 3s

        # How long to wait for contact points to be discovered
        contact-point-discovery-effective-timeout = 10s
      }

      # Contact point fallback port (if not discovered)
      contact-point.fallback-port = 8558

      # Stable margin before cluster formation
      stable-margin = 5s

      # Contact point HTTP probe configuration
      contact-point.probe-interval = 1s
      contact-point.probe-timeout = 3s
    }
  }

  # ============================================
  # SERVICE DISCOVERY
  # ============================================
  discovery {
    # Config-based discovery for local development
    config {
      services {
        dataflow-platform {
          endpoints = [
            {
              host = "127.0.0.1"
              port = 8558
            }
          ]
        }
      }
    }

    # Kubernetes API discovery (for production)
    kubernetes-api {
      # Namespace to query (empty = same namespace)
      pod-namespace = "default"
      pod-namespace = ${?KUBERNETES_NAMESPACE}

      # Label selector for pod discovery
      pod-label-selector = "app=%s"

      # Port name to use
      pod-port-name = "management"
    }
  }

  # ============================================
  # CLUSTER
  # ============================================
  cluster {
    # Seed nodes for cluster formation
    seed-nodes = [
      "pekko://DataflowPlatform@127.0.0.1:2551"
    ]
    seed-nodes = ${?PEKKO_CLUSTER_SEED_NODES}

    # Roles for this node
    roles = ["pipeline-processor"]

    # Downing provider for handling split-brain scenarios
    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"

    # Split Brain Resolver configuration
    split-brain-resolver {
      # Strategy: static-quorum, keep-majority, keep-oldest, keep-referee
      active-strategy = keep-majority

      # Time margin for downing decisions
      stable-after = 20s

      # Down all nodes if cluster is smaller than this
      down-all-when-unstable = on
    }

    # Failure detector settings
    failure-detector {
      # Threshold for failure detection
      threshold = 12.0

      # Expected response time
      acceptable-heartbeat-pause = 10s

      # Heartbeat interval
      heartbeat-interval = 2s
    }

    # Cluster sharding configuration
    sharding {
      # Number of shards
      number-of-shards = 100

      # Timeout for asking the coordinator for shard location
      coordinator-singleton-lease-retry-interval = 5s

      # Remember entities settings
      remember-entities = on
      remember-entities-store = "eventsourced"

      # Passivation settings
      passivate-idle-entity-after = 2 hours

      # Rebalancing
      least-shard-allocation-strategy {
        rebalance-threshold = 10
        max-simultaneous-rebalance = 3
      }
    }

    # Cluster singleton settings
    singleton {
      # Minimum number of cluster members before singleton is started
      min-number-of-members = 1

      # Singleton role (empty = all nodes can host singleton)
      role = ""

      # Timeout for handover
      hand-over-retry-interval = 1s
    }

    # Distributed data settings
    distributed-data {
      # Role of nodes to use for distributed data
      role = ""

      # How often to gossip
      gossip-interval = 2s

      # How long to wait for majority ack
      notify-subscribers-interval = 500ms
    }
  }
}