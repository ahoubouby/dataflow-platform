# ============================================
# CLUSTER CONFIGURATION
# ============================================


pekko {
  cluster {
    # Seed nodes for cluster formation
    seed-nodes = [
      "pekko://DataflowPlatform@127.0.0.1:2551"
    ]
    seed-nodes = ${?PEKKO_CLUSTER_SEED_NODES}

    # Roles for this node
    roles = ["pipeline-processor"]

    # Downing provider for handling split-brain scenarios
    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"

    # Split Brain Resolver configuration
    split-brain-resolver {
      # Strategy: static-quorum, keep-majority, keep-oldest, keep-referee
      active-strategy = keep-majority

      # Time margin for downing decisions
      stable-after = 20s

      # Down all nodes if cluster is smaller than this
      down-all-when-unstable = on
    }

    # Failure detector settings
    failure-detector {
      # Threshold for failure detection
      threshold = 12.0

      # Expected response time
      acceptable-heartbeat-pause = 10s

      # Heartbeat interval
      heartbeat-interval = 2s
    }

    # Cluster sharding configuration
    sharding {
      # Number of shards
      number-of-shards = 100

      # Timeout for asking the coordinator for shard location
      coordinator-singleton-lease-retry-interval = 5s

      # Remember entities settings
      remember-entities = on
      remember-entities-store = "eventsourced"

      # Passivation settings
      passivate-idle-entity-after = 2 hours

      # Rebalancing
      least-shard-allocation-strategy {
        rebalance-threshold = 10
        max-simultaneous-rebalance = 3
      }
    }

    # Cluster singleton settings
    singleton {
      # Minimum number of cluster members before singleton is started
      min-number-of-members = 1

      # Singleton role (empty = all nodes can host singleton)
      role = ""

      # Timeout for handover
      hand-over-retry-interval = 1s
    }

    # Distributed data settings
    distributed-data {
      # Role of nodes to use for distributed data
      role = ""

      # How often to gossip
      gossip-interval = 2s

      # How long to wait for majority ack
      notify-subscribers-interval = 500ms
    }
  }
}